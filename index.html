<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualizador 3D de Permutaciones - Modalidades Manual y Evolutiva</title>
  <style>
    body {
      margin: 0; overflow: hidden; background: #ffffff;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-weight: 200; font-size: 12px; cursor: none;
    }
    #customCursor {
      position: fixed; width:12px; height:12px; border-radius:50%;
      background:#000; border:1px solid:#fff; pointer-events:none;
      z-index:300; transform:translate(-50%,-50%);
    }
    #topRightDisplay {
      position: fixed; top:5px; right:10px; z-index:280;
      color:#000; font-size:12px; line-height:1.2;
    }
    #controls {
      position:absolute; top:10px; left:10px; z-index:100;
      padding:10px; border-radius:5px; max-width:350px;
      background: rgba(255,255,255,0.8);
    }
    details { margin-bottom:10px; }
    details summary { font-weight:200; cursor:pointer; }
    details summary:hover { color:#333; }
    select, input, button { cursor:none; }
    #permutationList { width:100%; height:300px; }
    #attrMapping { width:100%; }
    #hoverPopup {
      position:absolute; padding:5px 10px;
      background:rgba(0,0,0,0.7); color:#fff;
      border-radius:4px; pointer-events:none;
      font-size:12px; display:none; opacity:0;
      transition:opacity .3s;
      z-index:200;
    }
    /* Botones flotantes */
    .floatBtn {
      position:fixed; right:10px; z-index:250;
      background:transparent; border:none;
      padding:8px 12px; font-size:12px;
      cursor:none; border-radius:4px;
    }
    #toggleTextButton { bottom:10px; }
    #randomConfigButton { bottom:40px; }
    #saveImageButton   { bottom:70px; }
    #exportEmbedButton { bottom:100px;}
    #aiEvolutionBtn    { bottom:130px;}
    /* Calificación */
    #ratingContainer {
      position:fixed; bottom:160px; right:10px; z-index:260;
      font-size:12px;
    }
    #ratingControls { margin-top:4px; }
    #ratingLabels, #ratingDots {
      display:flex; justify-content:space-between;
    }
    #ratingLabels { margin-bottom:4px; }
    .ratingBtn { font-size:20px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="customCursor"></div>
  <div id="topRightDisplay"></div>

  <button id="randomConfigButton" class="floatBtn" onclick="generateRandomConfiguration()">Configuración Aleatoria</button>
  <button id="toggleTextButton" class="floatBtn" onclick="toggleTexts()">Ocultar Textos</button>
  <button id="saveImageButton"   class="floatBtn" onclick="saveImage()">Guardar Imagen</button>
  <button id="exportEmbedButton" class="floatBtn" onclick="exportEmbed()">Guardar Embed</button>
  <button id="aiEvolutionBtn"    class="floatBtn">Evolución AI</button>

  <div id="ratingContainer">
    <details open>
      <summary>Calificar Configuración</summary>
      <div id="ratingControls">
        <div id="ratingLabels">
          <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
        </div>
        <div id="ratingDots">
          <span class="ratingBtn" data-rating="1">●</span>
          <span class="ratingBtn" data-rating="2">●</span>
          <span class="ratingBtn" data-rating="3">●</span>
          <span class="ratingBtn" data-rating="4">●</span>
          <span class="ratingBtn" data-rating="5">●</span>
        </div>
      </div>
    </details>
  </div>

  <div id="controls">
    <details open>
      <summary>Modo de Operación</summary>
      <label><input type="radio" name="mode" value="manual" checked onchange="setMode(this.value)"> Manual</label>
      <label><input type="radio" name="mode" value="evolution" onchange="setMode(this.value)"> Evolutivo</label>
    </details>

    <div id="manualControls">
      <details>
        <summary>Seleccionar Permutaciones</summary>
        <select id="permutationList" multiple></select>
        <button onclick="updateScene()">Visualizar Permutación</button>
      </details>
    </div>

    <div id="evolutionControls" style="display:none;">
      <details open>
        <summary>Parámetros Evolutivos</summary>
        <p>Tasa de Mutación: <input type="range" id="mutationRate" min="0" max="1" step="0.01" value="0.1"></p>
        <p>Umbral de Cambio: <input type="range" id="threshold"    min="0" max="1" step="0.01" value="0.5"></p>
        <button onclick="applyEvolution()">Aplicar Evolución Manual</button>
        <div id="evolutionInfo" style="margin-top:8px;font-size:12px;"></div>
      </details>
    </div>

    <details>
      <summary>Seleccionar Colores Permutaciones</summary>
      <div class="color-picker"><label>1: <input type="color" id="color1" value="#ff0000"></label></div>
      <div class="color-picker"><label>2: <input type="color" id="color2" value="#00ff00"></label></div>
      <div class="color-picker"><label>3: <input type="color" id="color3" value="#0000ff"></label></div>
      <div class="color-picker"><label>4: <input type="color" id="color4" value="#ff00ff"></label></div>
      <div class="color-picker"><label>5: <input type="color" id="color5" value="#00ffff"></label></div>
      <button onclick="updateColorMapping()">Actualizar Colores</button>
    </details>

    <details>
      <summary>Seleccionar Fondo del Universo</summary>
      <input type="color" id="bgColor" value="#ffffff">
      <button onclick="updateBackground()">Actualizar Fondo</button>
    </details>

    <details>
      <summary>Seleccionar Color de Pared del Cubo</summary>
      <input type="color" id="cubeColor" value="#808080">
      <button onclick="updateCubeColor()">Actualizar Paredes</button>
    </details>

    <details>
      <summary>Reorganización de Atributos</summary>
      <select id="attrMapping"></select>
      <button onclick="updateMapping()">Aplicar Mapping</button>
      <button onclick="autoResolveColisionesGlobal()">Resolver Colisiones</button>
    </details>

    <details>
      <summary>Vistas Estándar</summary>
      <select id="standardView">
        <option value="isometric">Isométrica</option>
        <option value="top">Superior</option>
        <option value="front">Frontal</option>
        <option value="side">Lateral</option>
        <option value="diagonal">Diagonal</option>
      </select>
      <button onclick="applyStandardView()">Aplicar Vista</button>
    </details>

    <details>
      <summary>Zoom y Movimiento</summary>
      <button onclick="zoomIn()">Zoom In</button>
      <button onclick="zoomOut()">Zoom Out</button>
      <button onclick="togglePause()">Pausar/Continuar</button>
      <button onclick="resetMovement()">Resetear Movimiento</button>
    </details>
  </div>

  <div id="hoverPopup"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    // ——————————————————————————————————————————————
    // === CONSTANTES Y UTILIDADES
    const CUSTOM_COLORS = [ /* tus 120 colores aquí */ /* … */ ];
    function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
    function mapRangeToSpeed(r,mn,mx){ return 0.001+(r-mn)*(0.005-0.001)/(mx-mn); }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    // ——————————————————————————————————————————————
    // === VARIABLES GLOBALES
    let scene, camera, renderer, controls, raycaster, mouse;
    let cubeUniverse, permutationGroup;
    let isPaused=false, currentMode="manual", userRating=null, textsVisible=true;
    let attributeMapping={forma:0,color:1,x:2,y:3,z:4};
    let colorMapping={1:"#ff0000",2:"#00ff00",3:"#0000ff",4:"#ff00ff",5:"#00ffff"};

    const cubeSize=30, segment=cubeSize/5, halfCube=cubeSize/2;
    const minRangeValue=2, maxRangeValue=6;
    const shapeMapping={
      1:{w:4.5,h:4.5},
      2:{w:4.5,h:4.5*Math.sqrt(2)},
      3:{w:4.5,h:4.5*Math.sqrt(3)},
      4:{w:4.5,h:4.5*Math.sqrt(4)},
      5:{w:4.5,h:4.5*Math.sqrt(5)}
    };

    // ——————————————————————————————————————————————
    // === GENERAR PERMUTACIONES
    function getPermutations(arr){
      if(arr.length===1) return [arr];
      let res=[];
      for(let i=0;i<arr.length;i++){
        let c=arr[i], rem=arr.slice(0,i).concat(arr.slice(i+1));
        for(let p of getPermutations(rem)) res.push([c].concat(p));
      }
      return res;
    }
    const allPerms = getPermutations([1,2,3,4,5]);
    const permutationStrings = allPerms.map(p=>p.join(','));

    // ——————————————————————————————————————————————
    // === POBLAR SELECTS
    function populatePermutationList(){
      const sel = document.getElementById('permutationList');
      sel.innerHTML='';
      permutationStrings.forEach((ps,i)=>{
        let o=document.createElement('option');
        o.value=ps; o.text=`Permutación ${i+1}: (${ps})`;
        if(i<3) o.selected=true;
        sel.appendChild(o);
      });
    }
    function getAttributeMappings(a){
      if(a.length===1) return [a];
      let res=[];
      for(let i=0;i<a.length;i++){
        let c=a[i], rem=a.slice(0,i).concat(a.slice(i+1));
        for(let m of getAttributeMappings(rem)) res.push([c].concat(m));
      }
      return res;
    }
    function populateAttributeMappingSelect(){
      const sel = document.getElementById('attrMapping');
      sel.innerHTML='';
      getAttributeMappings([0,1,2,3,4]).forEach(m=>{
        let s=m.join(','), o=document.createElement('option');
        o.value=s; o.text=`[${s}]`;
        if(s==='0,1,2,3,4') o.selected=true;
        sel.appendChild(o);
      });
    }

    // ——————————————————————————————————————————————
    // === DISPLAY SUPERIOR
    function updateTopRightDisplay(){
      const cfg=`Mapping: [${attributeMapping.forma},${attributeMapping.color},${attributeMapping.x},${attributeMapping.y},${attributeMapping.z}]`;
      const rt=`Calificación: ${userRating||'–'}`;
      let info='';
      Array.from(document.getElementById('permutationList').selectedOptions)
        .forEach(o=>{
          let pa=o.value.split(',').map(Number),
              sig=pa.map((v,i)=>v+pa[(i+1)%pa.length]),
              rg=Math.max(...sig)-Math.min(...sig);
          info+=`<div>(${pa.join(',')}) Rango ${rg}</div>`;
        });
      document.getElementById('topRightDisplay').innerHTML=cfg+'<br>'+rt+'<br>'+info;
    }

    // ——————————————————————————————————————————————
    // === CREAR OBJETOS 3D
    function createPermutationObjectWithMapping(pa,map){
      let fv=pa[map.forma], cv=pa[map.color],
          px=pa[map.x], py=pa[map.y], pz=pa[map.z],
          d=shapeMapping[fv], w=d.w, h=d.h, t=0.5;
      let geo=new THREE.BoxGeometry(w,h,t),
          mat=new THREE.MeshPhongMaterial({ color:new THREE.Color(colorMapping[cv]), shininess:50 }),
          mesh=new THREE.Mesh(geo,mat);
      let x=(px-1)*segment-halfCube+segment/2,
          y=(py-1)*segment-halfCube+segment/2,
          z=(pz-1)*segment-halfCube+segment/2;
      mesh.position.set(
        clamp(x,-halfCube+w/2,halfCube-w/2),
        clamp(y,-halfCube+h/2,halfCube-h/2),
        clamp(z,-halfCube+t/2,halfCube-t/2)
      );
      let sig=pa.map((v,i)=>v+pa[(i+1)%pa.length]),
          rg=Math.max(...sig)-Math.min(...sig);
      mesh.userData={permStr:pa.join(','), signature:sig, range:rg, rotationSpeed: mapRangeToSpeed(rg,minRangeValue,maxRangeValue)};
      return mesh;
    }
    function createPermutationObject(pa){ return createPermutationObjectWithMapping(pa,attributeMapping); }

    // ——————————————————————————————————————————————
    // === COLISIONES
    function checkCollisionsInGroup(g){
      for(let i=0;i<g.children.length;i++){
        let b1=new THREE.Box3().setFromObject(g.children[i]);
        for(let j=i+1;j<g.children.length;j++){
          let b2=new THREE.Box3().setFromObject(g.children[j]);
          if(b1.intersectsBox(b2)) return true;
        }
      }
      return false;
    }
    function autoResolveColisionesGlobal(){
      let found=null;
      getAttributeMappings([0,1,2,3,4]).some(m=>{
        if(found) return true;
        const cm={forma:m[0],color:m[1],x:m[2],y:m[3],z:m[4]};
        const tg=new THREE.Group();
        Array.from(document.getElementById('permutationList').selectedOptions)
          .forEach(o=>{
            let pa=o.value.split(',').map(Number),
                mo=createPermutationObjectWithMapping(pa,cm);
            tg.add(mo);
          });
        if(!checkCollisionsInGroup(tg)) found=cm;
        return false;
      });
      if(found){
        attributeMapping=found;
        document.getElementById('attrMapping').value=Object.values(found).join(',');
        updateScene(false); updateTopRightDisplay();
        showPopup("Mapping sin colisiones encontrado",3000);
      } else {
        showPopup("No se encontró mapping sin colisiones",3000);
      }
    }

    // ——————————————————————————————————————————————
    // === POPUP
    function showPopup(msg,dur=2000){
      const pop=document.getElementById('hoverPopup');
      pop.style.display="block"; pop.style.opacity=1;
      pop.style.left=(window.innerWidth/2-150)+"px";
      pop.style.top="20px"; pop.innerHTML=msg;
      setTimeout(()=>{ pop.style.opacity=0; setTimeout(()=>pop.style.display="none",300); },dur);
    }

    // ——————————————————————————————————————————————
    // === ACTUALIZAR ESCENA
    function updateScene(attemptResolve=true){
      while(permutationGroup.children.length) {
        const o=permutationGroup.children[0];
        permutationGroup.remove(o);
        o.geometry.dispose(); o.material.dispose();
      }
      Array.from(document.getElementById('permutationList').selectedOptions)
        .forEach((o,i)=>{
          let pa=o.value.split(',').map(Number),
              obj=createPermutationObject(pa);
          if(i>0){
            const ang=2*Math.PI*i/5, rad=1.5;
            obj.position.x+=rad*Math.cos(ang);
            obj.position.y+=rad*Math.sin(ang);
          }
          permutationGroup.add(obj);
        });
      if(attemptResolve) autoResolveColisionesGlobal();
      else updateTopRightDisplay();
    }

    // ——————————————————————————————————————————————
    // === RAYCAST & HOVER
    function onMouseMove(e){
      mouse.x=(e.clientX/window.innerWidth)*2-1;
      mouse.y=-(e.clientY/window.innerHeight)*2+1;
      raycaster.setFromCamera(mouse,camera);
      const ints=raycaster.intersectObjects(permutationGroup.children);
      const pop=document.getElementById('hoverPopup');
      if(ints.length){
        const d=ints[0].object.userData;
        pop.style.display="block"; pop.style.opacity=1;
        pop.style.left=e.clientX+20+"px"; pop.style.top=e.clientY+20+"px";
        pop.innerHTML=`(${d.permStr}) Rango ${d.range}`;
      } else {
        pop.style.opacity=0; setTimeout(()=>pop.style.display="none",300);
      }
    }

    // ——————————————————————————————————————————————
    // === ZOOM & MOVIMIENTO
    function zoomIn(){ camera.position.z-=5; controls.update(); }
    function zoomOut(){ camera.position.z+=5; controls.update(); }
    function togglePause(){
      isPaused=!isPaused;
      document.querySelector("#controls button[onclick='togglePause()']")
        .textContent = isPaused? "Continuar":"Pausar";
    }
    function resetMovement(){
      isPaused=true; updateScene(false);
      document.querySelector("#controls button[onclick='togglePause()']")
        .textContent = "Continuar";
    }

    // ——————————————————————————————————————————————
    // === GUARDAR IMAGEN
    function saveImage(){
      renderer.render(scene,camera);
      const url=renderer.domElement.toDataURL("image/png"),
            a=document.createElement("a");
      a.href=url; a.download="captura.png";
      document.body.appendChild(a); a.click(); a.remove();
    }

    // ——————————————————————————————————————————————
    // === ACTUALIZAR COLORES MANUAL
    function updateColorMapping(){
      for(let i=1;i<=5;i++){
        colorMapping[i]=document.getElementById('color'+i).value;
      }
      updateScene(false);
    }
    function updateBackground(){
      const c=document.getElementById('bgColor').value;
      scene.background=new THREE.Color(c);
    }
    function updateCubeColor(){
      const c=document.getElementById('cubeColor').value;
      cubeUniverse.material.color=new THREE.Color(c);
    }

    // ——————————————————————————————————————————————
    // === TOGGLE TEXTOS
    function toggleTexts(){
      textsVisible=!textsVisible;
      const elems=[
        'controls','topRightDisplay','ratingContainer',
        'randomConfigButton','saveImageButton','exportEmbedButton','aiEvolutionBtn'
      ];
      elems.forEach(id=>{
        document.getElementById(id).style.display = textsVisible? 'block':'none';
      });
      document.getElementById('toggleTextButton')
        .textContent = textsVisible? "Ocultar Textos":"Mostrar Textos";
    }

    // ——————————————————————————————————————————————
    // === MODO MANUAL/EVOLUTIVO
    function setMode(m){
      currentMode=m;
      document.getElementById('manualControls').style.display = m==="manual"? "block":"none";
      document.getElementById('evolutionControls').style.display = m==="evolution"? "block":"none";
    }

    // ——————————————————————————————————————————————
    // === CONFIGURACIÓN ALEATORIA
    function generateRandomConfiguration(){
      // permutaciones
      const opts=document.getElementById('permutationList').options;
      Array.from(opts).forEach(o=>o.selected=false);
      for(let i=0;i<3;i++){
        opts[Math.floor(Math.random()*opts.length)].selected=true;
      }
      // fondo y paredes
      const bg=CUSTOM_COLORS[Math.floor(Math.random()*CUSTOM_COLORS.length)];
      const wall=CUSTOM_COLORS[Math.floor(Math.random()*CUSTOM_COLORS.length)];
      document.getElementById('bgColor').value=bg; updateBackground();
      document.getElementById('cubeColor').value=wall; updateCubeColor();
      // colores perm
      let pool=shuffle(CUSTOM_COLORS.slice());
      for(let i=1;i<=5;i++){
        colorMapping[i]=pool.shift();
        document.getElementById('color'+i).value=colorMapping[i];
      }
      updateScene(false);
    }

    // ——————————————————————————————————————————————
    // === CALIFICACIÓN
    document.querySelectorAll('.ratingBtn').forEach(el=>{
      const r=+el.dataset.rating;
      el.addEventListener('click', ()=>{
        userRating=r;
        const cols=[null,"#8B0000","#FF4500","#FFA500","#9ACD32","#008000"];
        document.querySelectorAll('.ratingBtn').forEach((b,i)=>{
          b.style.color=(i<r? cols[r]:"#000");
        });
        updateTopRightDisplay();
      });
    });

    // ——————————————————————————————————————————————
    // === EVOLUCIÓN MANUAL
    function applyEvolution(){
      const mr=parseFloat(document.getElementById('mutationRate').value);
      const th=parseFloat(document.getElementById('threshold').value);
      let log="";
      permutationGroup.children.forEach(o=>{
        const rf=(Math.random()-0.5)*mr;
        o.rotation.y+=rf;
        const sf=1+(Math.random()-0.5)*th;
        o.scale.set(sf,sf,sf);
        const cf=0.02;
        o.material.color.offsetHSL(
          (Math.random()-0.5)*cf,
          (Math.random()-0.5)*cf,
          (Math.random()-0.5)*cf
        );
        log+=`[${o.userData.permStr}] rot ${rf.toFixed(2)} esc ${sf.toFixed(2)}<br>`;
      });
      document.getElementById('evolutionInfo').innerHTML=log;
    }

    // ——————————————————————————————————————————————
    // === EVOLUCIÓN AI (AUTÓNOMA)
    document.getElementById('aiEvolutionBtn')
      .addEventListener('click', aiEvolution);

    async function aiEvolution(){
      const rating = userRating||'sin calificar';
      const perms  = permutationGroup.children.map(o=>o.userData.permStr);
      const prompt = `
Eres un sistema evolutivo. Calificación actual: ${rating}.
Permutaciones desplegadas: ${perms.join('; ')}.
Fondo actual: ${scene.background.getStyle()}.
Color paredes: ${cubeUniverse.material.color.getStyle()}.
Responde SOLO un JSON con:
  "nuevosColores":[...],
  "cambioFondo":"#hex",
  "cambioParedes":"#hex",
  "escalaMin":n,"escalaMax":n,
  "velocidadRotacion":n,
  "contarCubos":n,
  "posiciones":[{"x":n,"y":n,"z":n},...]
`;
      try {
        const res = await fetch('https://us-central1-prmtcns.cloudfunctions.net/askChatGPT', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({prompt})
        });
        const { text } = await res.json();
        const cfg = JSON.parse(text);

        // Aplicar fondo
        if(cfg.cambioFondo){
          scene.background=new THREE.Color(cfg.cambioFondo);
        }
        // Aplicar paredes
        if(cfg.cambioParedes){
          cubeUniverse.material.color=new THREE.Color(cfg.cambioParedes);
        }
        // Nuevos colores perm
        if(Array.isArray(cfg.nuevosColores)){
          cfg.nuevosColores.forEach((hex,i)=>{
            if(i<5){
              colorMapping[i+1]=hex;
              document.getElementById('color'+(i+1)).value=hex;
            }
          });
        }
        // Número de cubos
        if(Number.isInteger(cfg.contarCubos)){
          const opts=document.getElementById('permutationList').options;
          Array.from(opts).forEach(o=>o.selected=false);
          for(let i=0;i<cfg.contarCubos && i<opts.length;i++){
            opts[i].selected=true;
          }
        }
        // Posiciones
        if(Array.isArray(cfg.posiciones)){
          cfg.posiciones.forEach((p,i)=>{
            if(permutationGroup.children[i]){
              permutationGroup.children[i].position.set(p.x,p.y,p.z);
            }
          });
        }
        // Escalas y velocidades
        permutationGroup.children.forEach(o=>{
          if(cfg.escalaMin!=null && cfg.escalaMax!=null){
            let s=Math.random()*(cfg.escalaMax-cfg.escalaMin)+cfg.escalaMin;
            o.scale.set(s,s,s);
          }
          if(cfg.velocidadRotacion!=null){
            o.userData.rotationSpeed = cfg.velocidadRotacion;
          }
        });

        updateScene(false);
        updateTopRightDisplay();
        showPopup("Evolución AI aplicada ✔️",3000);
      } catch(e){
        console.error(e);
        showPopup("Error en Evolución AI",3000);
      }
    }

    // ——————————————————————————————————————————————
    // === VISTA ESTÁNDAR
    function applyStandardView(){
      let view=document.getElementById('standardView').value, pos=new THREE.Vector3();
      switch(view){
        case"top": pos.set(0,80,0); break;
        case"front": pos.set(0,0,50); break;
        case"side": pos.set(50,0,0); break;
        case"diagonal": pos.set(-50,50,-50); break;
        default: pos.set(50,50,50);
      }
      camera.position.copy(pos);
      camera.lookAt(0,0,0);
      controls.update();
    }

    // ——————————————————————————————————————————————
    // === EMBED & URL PARAMS
    function applyEmbedParams(){
      const p=new URLSearchParams(location.search);
      if(p.has('perms')){
        const arr=p.get('perms').split(';');
        Array.from(document.getElementById('permutationList').options)
          .forEach(o=> o.selected=arr.includes(o.value));
      }
      if(p.has('mapping')){
        const m=p.get('mapping').split(',').map(Number);
        attributeMapping={forma:m[0],color:m[1],x:m[2],y:m[3],z:m[4]};
        document.getElementById('attrMapping').value=p.get('mapping');
      }
      if(p.has('colors')){
        p.get('colors').split(',').forEach((c,i)=>{
          if(i<5){
            colorMapping[i+1]='#'+c;
            document.getElementById('color'+(i+1)).value='#'+c;
          }
        });
      }
      if(p.has('bg')){
        const bg='#'+p.get('bg');
        document.getElementById('bgColor').value=bg; updateBackground();
      }
      if(p.has('cube')){
        const c='#'+p.get('cube');
        document.getElementById('cubeColor').value=c; updateCubeColor();
      }
      if(p.has('view')){
        document.getElementById('standardView').value=p.get('view');
        applyStandardView();
      }
      if(p.get('hide')==='1') toggleTexts();
    }

    function exportEmbed(){
      const perms=Array.from(document.getElementById('permutationList').selectedOptions).map(o=>o.value).join(';');
      const mapping=Object.values(attributeMapping).join(',');
      const colors=[1,2,3,4,5].map(i=>document.getElementById('color'+i).value.slice(1)).join(',');
      const bg=document.getElementById('bgColor').value.slice(1);
      const cube=document.getElementById('cubeColor').value.slice(1);
      const view=document.getElementById('standardView').value;
      const src=`${location.pathname}?perms=${encodeURIComponent(perms)}&mapping=${mapping}&colors=${colors}&bg=${bg}&cube=${cube}&view=${view}&hide=1`;
      prompt("Código iframe:", `<iframe src="${src}" width="800" height="600"></iframe>`);
    }

    // ——————————————————————————————————————————————
    // === INITIALIZE
    function initCustomCursor(){
      const c=document.getElementById('customCursor');
      window.addEventListener('mousemove', e=> {
        c.style.left=e.clientX+'px';
        c.style.top =e.clientY+'px';
      });
    }
    function initRenderer(){
      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth,window.innerHeight);
      document.body.appendChild(renderer.domElement);
    }
    function init(){
      scene=new THREE.Scene(); scene.background=new THREE.Color(0xffffff);
      camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
      camera.position.set(50,50,50);
      initRenderer();
      controls=new THREE.OrbitControls(camera,renderer.domElement);
      controls.enableDamping=true; controls.dampingFactor=0.1;

      scene.add(new THREE.AmbientLight(0xffffff,0.8));
      const dir=new THREE.DirectionalLight(0xffffff,0.5);
      dir.position.set(1,1,1); scene.add(dir);

      cubeUniverse=new THREE.Mesh(
        new THREE.BoxGeometry(cubeSize,cubeSize,cubeSize),
        new THREE.MeshBasicMaterial({color:0x808080,transparent:true,opacity:0.2,side:THREE.BackSide})
      );
      scene.add(cubeUniverse);

      permutationGroup=new THREE.Group(); scene.add(permutationGroup);

      raycaster=new THREE.Raycaster();
      mouse=new THREE.Vector2();
      window.addEventListener('mousemove',onMouseMove);
      window.addEventListener('resize',()=> {
        camera.aspect=window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth,window.innerHeight);
      });

      initCustomCursor();
      populatePermutationList();
      populateAttributeMappingSelect();
      applyEmbedParams();
      setMode("manual");
      updateScene(false);
      animate();
    }
    function animate(){
      requestAnimationFrame(animate);
      if(!isPaused){
        permutationGroup.children.forEach(o=>{
          o.rotation.y+=o.userData.rotationSpeed;
        });
      }
      controls.update();
      renderer.render(scene,camera);
    }
    init();
  </script>
</body>
</html>
