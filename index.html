<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualizador 3D de Permutaciones - Modalidades Manual y Evolutiva</title>
  <style>
    body { margin:0; overflow:hidden; background:#fff; font-family:"Helvetica Neue",Helvetica,Arial,sans-serif; font-weight:200; font-size:12px; cursor:none; }
    #customCursor { position:fixed; width:12px; height:12px; border-radius:50%; background:#000; border:1px solid #fff; pointer-events:none; z-index:300; transform:translate(-50%,-50%); }
    #topRightDisplay { position:fixed; top:5px; right:10px; z-index:280; color:#000; font-size:12px; line-height:1.2; }
    #controls { position:absolute; top:10px; left:10px; z-index:100; padding:10px; border-radius:5px; max-width:350px; }
    details { margin-bottom:10px; }
    details summary { font-weight:200; cursor:pointer; }
    details summary:hover { color:#333; }
    select, input, button { cursor:none; }
    #permutationList { width:100%; height:300px; }
    #attrMapping { width:100%; }
    #hoverPopup { position:absolute; padding:5px 10px; background:rgba(0,0,0,0.7); color:#fff; border-radius:4px; pointer-events:none; font-size:12px; display:none; opacity:0; transition:opacity .3s; z-index:200; }
    /* Botones flotantes */
    #randomConfigButton, #toggleTextButton, #saveImageButton, #exportEmbedButton {
      position:fixed; z-index:250; background:transparent; border:none; padding:8px 12px; font-size:12px; cursor:pointer; border-radius:4px;
    }
    #toggleTextButton { bottom:10px; right:10px; }
    #randomConfigButton { bottom:40px; right:10px; }
    #saveImageButton { bottom:70px; right:10px; }
    #exportEmbedButton { bottom:100px; right:10px; }
    /* Calificación */
    #ratingContainer { position:fixed; bottom:130px; right:10px; z-index:260; font-size:12px; }
    #ratingControls { margin-top:4px; }
    #ratingLabels, #ratingDots { display:flex; justify-content:space-between; }
    .ratingBtn { font-size:20px; cursor:pointer; }
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="customCursor"></div>
  <div id="topRightDisplay"></div>

  <button id="randomConfigButton" onclick="generateRandomConfiguration()">Configuración Aleatoria</button>
  <button id="toggleTextButton" onclick="toggleTexts()">Ocultar Textos</button>
  <button id="saveImageButton" onclick="saveImage()">Guardar Imagen</button>
  <button id="exportEmbedButton" onclick="exportEmbed()">Guardar</button>

  <div id="ratingContainer">
    <details open>
      <summary>Calificar Configuración</summary>
      <div id="ratingControls">
        <div id="ratingLabels">
          <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
        </div>
        <div id="ratingDots">
          <span class="ratingBtn" data-rating="1">●</span>
          <span class="ratingBtn" data-rating="2">●</span>
          <span class="ratingBtn" data-rating="3">●</span>
          <span class="ratingBtn" data-rating="4">●</span>
          <span class="ratingBtn" data-rating="5">●</span>
        </div>
      </div>
    </details>
  </div>

  <div id="controls">
    <details open>
      <summary>Modo de Operación</summary>
      <label><input type="radio" name="mode" value="manual" checked onchange="setMode(this.value)"> Manual</label>
      <label><input type="radio" name="mode" value="evolution" onchange="setMode(this.value)"> Evolutivo</label>
    </details>
    <div id="manualControls">
      <details>
        <summary>Seleccionar Permutaciones</summary>
        <select id="permutationList" multiple></select>
        <button onclick="updateScene()">Visualizar Permutación</button>
      </details>
    </div>
    <div id="evolutionControls" style="display:none;">
      <details open>
        <summary>Parámetros Evolutivos</summary>
        <p>Tasa de Mutación: <input type="range" id="mutationRate" min="0" max="1" step="0.01" value="0.1"></p>
        <p>Umbral de Cambio: <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.5"></p>
        <button onclick="applyEvolution()">Aplicar Evolución</button>
        <div id="evolutionInfo" style="margin-top:8px;font-size:12px;"></div>
      </details>
    </div>
    <details>
      <summary>Seleccionar Colores Permutaciones</summary>
      <div class="color-picker"><label>1: <input type="color" id="color1" value="#ff0000"></label></div>
      <div class="color-picker"><label>2: <input type="color" id="color2" value="#00ff00"></label></div>
      <div class="color-picker"><label>3: <input type="color" id="color3" value="#0000ff"></label></div>
      <div class="color-picker"><label>4: <input type="color" id="color4" value="#ff00ff"></label></div>
      <div class="color-picker"><label>5: <input type="color" id="color5" value="#00ffff"></label></div>
      <button onclick="updateColorMapping()">Actualizar Colores</button>
    </details>
    <details>
      <summary>Seleccionar Fondo del Universo</summary>
      <input type="color" id="bgColor" value="#ffffff">
      <button onclick="updateBackground()">Actualizar Fondo</button>
    </details>
    <details>
      <summary>Seleccionar Color de Pared del Cubo</summary>
      <input type="color" id="cubeColor" value="#808080">
      <button onclick="updateCubeColor()">Actualizar Paredes</button>
    </details>
    <details>
      <summary>Reorganización de Atributos</summary>
      <select id="attrMapping"></select>
      <button onclick="updateMapping()">Aplicar Reorganización</button>
      <button onclick="autoResolveColisionesGlobal()">Resolver Colisiones</button>
    </details>
    <details>
      <summary>Vistas Estándar</summary>
      <select id="standardView">
        <option value="isometric">Isométrica</option>
        <option value="top">Superior</option>
        <option value="front">Frontal</option>
        <option value="side">Lateral</option>
        <option value="diagonal">Diagonal opuesta</option>
      </select>
      <button onclick="applyStandardView()">Aplicar Vista</button>
    </details>
    <details>
      <summary>Controles de Zoom</summary>
      <button onclick="zoomIn()">Zoom In</button>
      <button onclick="zoomOut()">Zoom Out</button>
    </details>
    <details>
      <summary>Controles de Movimiento</summary>
      <button onclick="togglePause()">Pausar Movimiento</button>
      <button onclick="resetMovement()">Resetear Movimiento</button>
    </details>
  </div>

  <div id="hoverPopup"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // === Inicializar Firebase (compat)
    firebase.initializeApp({
      apiKey: "AIzaSyD85cZXzkLpsJxV787aAOgwlJpXP95eHK4",
      authDomain: "prmtcns.firebaseapp.com",
      projectId: "prmtcns",
      storageBucket: "prmtcns.firebasestorage.app",
      messagingSenderId: "1039516253353",
      appId: "1:1039516253353:web:7c5cac966999ad3c5cfdb8",
      measurementId: "G-17K4T112VE"
    });
    const db = firebase.firestore();
    async function loadTopConfigs() {
      const snap = await db.collection("ratings").where("rating", ">=", 4).get();
      window.topConfigs = snap.docs.map(d => d.data().config);
    }
    loadTopConfigs();

    // === Colores personalizados
    const CUSTOM_COLORS = [
      "#070709","#898052","#402523","#0d080a","#070909","#050608","#070509",
      "#12080d","#330a0d","#9c714f","#382e24","#883933","#decda0",
      "#fafcff","#a4b6bc","#e7e8e1","#f3f1ea","#eaebe2","#dcdacf","#f8f9f8",
      "#f6f5ea","#ffffff","#f3f3f0","#faf9f0","#f5f7f6","#eeece8","#fffef7",
      "#350b0c","#9e4031","#820707","#eeb049","#120607","#f6f1ed",
      "#300809","#8c2d18","#6a6620","#b99c5c","#110505","#5f2423",
      "#400909","#a04b37","#180506","#e1b055","#6f2919","#170607",
      "#000000","#9c822b","#3e1b2c","#edce83","#1b0408","#8a4667",
      "#000000","#ec9b1c","#701a25","#9c2c1a","#480b0b","#150407",
      "#2a0607","#b08b4f","#7a181d","#5d180f","#1f0908","#dfb46e",
      "#0b0304","#a4735a","#4e272a","#cab296","#923930","#1d0709",
      "#f4c061","#963326","#d89048","#430f0c","#ce5830","#72121a",
      "#fefffe","#c0b280","#57231d","#99541e","#210d0a","#8a5d2f",
      "#33090a","#e2a33f","#a24a2c","#591e14","#8f2e1c","#1e0809",
      "#bd4d1d","#441b1d","#0f0406","#e3a337","#886c39","#1a0807",
      "#fffcee","#cea564","#9a7859","#080103","#000003","#000100",
      "#000000","#6d4d2c","#2d060a","#000005","#000100","#2d0006",
      "#17120a","#451e18","#42401c","#7c4934","#8c7640","#c0b468"
    ];

    // === Variables globales
    let scene, camera, renderer, controls, raycaster, mouse;
    let cubeUniverse, permutationGroup;
    const cubeSize=30, segment=cubeSize/5, halfCube=cubeSize/2;
    let isPaused=false, currentMode="manual", userRating=null, textsVisible=true;
    let attributeMapping={forma:0,color:1,x:2,y:3,z:4};
    let colorMapping={1:"#ff0000",2:"#00ff00",3:"#0000ff",4:"#ff00ff",5:"#00ffff"};
    const minRangeValue=2, maxRangeValue=6;
    const shapeMapping={
      1:{w:4.5,h:4.5}, 2:{w:4.5,h:4.5*Math.sqrt(2)},
      3:{w:4.5,h:4.5*Math.sqrt(3)},4:{w:4.5,h:4.5*Math.sqrt(4)},
      5:{w:4.5,h:4.5*Math.sqrt(5)}
    };

    // === Utilidades
    function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
    function mapRangeToSpeed(r,mn,mx){ return 0.001 + (r-mn)*(0.005-0.001)/(mx-mn); }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function getPermutations(arr){
      if(arr.length===1) return [arr];
      let res=[];
      for(let i=0;i<arr.length;i++){
        let c=arr[i], rem=arr.slice(0,i).concat(arr.slice(i+1));
        for(let p of getPermutations(rem)) res.push([c].concat(p));
      }
      return res;
    }
    function computeSignature(a){ let s=[]; for(let i=0;i<a.length;i++) s.push(a[i]+a[(i+1)%a.length]); return s; }
    function computeRange(sig){ return Math.max(...sig) - Math.min(...sig); }

    const allPermutations = getPermutations([1,2,3,4,5]);
    const permutationStrings = allPermutations.map(p=>p.join(','));

    // === Poblado de selects
    function populatePermutationList(){
      let sel=document.getElementById('permutationList');
      sel.innerHTML='';
      permutationStrings.forEach((ps,i)=>{
        let o=document.createElement('option');
        o.value=ps; o.text=`Permutación ${i+1}: (${ps})`;
        if(i===0) o.selected=true;
        sel.appendChild(o);
      });
    }
    function getAttributeMappings(a){
      if(a.length===1) return [a];
      let res=[];
      for(let i=0;i<a.length;i++){
        let c=a[i], rem=a.slice(0,i).concat(a.slice(i+1));
        for(let pm of getAttributeMappings(rem)) res.push([c].concat(pm));
      }
      return res;
    }
    function populateAttributeMappingSelect(){
      let sel=document.getElementById('attrMapping');
      sel.innerHTML='';
      getAttributeMappings([0,1,2,3,4]).forEach(m=>{
        let s=m.join(','), o=document.createElement('option');
        o.value=s; o.text=`Opción: [${s}]`;
        if(s==='0,1,2,3,4') o.selected=true;
        sel.appendChild(o);
      });
      updateTopRightDisplay();
    }

    // === Display superior
    function updateTopRightDisplay(){
      let cfg=`Atributos: [${attributeMapping.forma},${attributeMapping.color},${attributeMapping.x},${attributeMapping.y},${attributeMapping.z}]`,
          rt=`Calificación: ${userRating?userRating:'Aún no calificada'}`,
          info='';
      Array.from(document.getElementById('permutationList').selectedOptions).forEach(o=>{
        let pa=o.value.split(',').map(Number),
            sig=computeSignature(pa),
            rg=computeRange(sig);
        info+=`<div style="margin:2px 0;">Perm (${o.value}) | Firma [${sig.join(', ')}] | Rango ${rg}</div>`;
      });
      document.getElementById('topRightDisplay').innerHTML = cfg+'<br>'+rt+'<br>'+info;
    }

    // === Crear objetos 3D
    function createPermutationObjectWithMapping(pa,map){
      let fv=pa[map.forma], cv=pa[map.color],
          px=pa[map.x], py=pa[map.y], pz=pa[map.z],
          d=shapeMapping[fv], w=d.w, h=d.h, t=0.5;
      let geo=new THREE.BoxGeometry(w,h,t),
          mat=new THREE.MeshPhongMaterial({ color:new THREE.Color(colorMapping[cv]), shininess:50 }),
          mesh=new THREE.Mesh(geo,mat);
      mesh.position.set(
        clamp((px-1)*segment-halfCube+segment/2, -halfCube+w/2, halfCube-w/2),
        clamp((py-1)*segment-halfCube+segment/2, -halfCube+h/2, halfCube-h/2),
        clamp((pz-1)*segment-halfCube+segment/2, -halfCube+t/2, halfCube-t/2)
      );
      let sig=computeSignature(pa), rg=computeRange(sig);
      mesh.userData={ permStr:pa.join(','), signature:sig, range:rg,
        rotationSpeed:mapRangeToSpeed(rg,minRangeValue,maxRangeValue) };
      return mesh;
    }
    function createPermutationObject(pa,i){
      return createPermutationObjectWithMapping(pa,attributeMapping);
    }

    // === Colisiones
    function checkCollisionsInGroup(g){
      for(let i=0;i<g.children.length;i++){
        let b1=new THREE.Box3().setFromObject(g.children[i]);
        for(let j=i+1;j<g.children.length;j++){
          let b2=new THREE.Box3().setFromObject(g.children[j]);
          if(b1.intersectsBox(b2)) return true;
        }
      }
      return false;
    }
    function autoResolveColisionesGlobal(){
      let found=null;
      getAttributeMappings([0,1,2,3,4]).forEach(m=>{
        if(found) return;
        let cm={ forma:m[0], color:m[1], x:m[2], y:m[3], z:m[4] },
            tg=new THREE.Group(),
            opts=Array.from(document.getElementById('permutationList').selectedOptions);
        opts.forEach((o,i)=>{
          let pa=o.value.split(',').map(Number),
              mo=createPermutationObjectWithMapping(pa,cm);
          if(opts.length>1){
            let ang=2*Math.PI*i/opts.length, rad=1.5;
            mo.position.x+=rad*Math.cos(ang);
            mo.position.y+=rad*Math.sin(ang);
            mo.position.x=clamp(mo.position.x,-halfCube+mo.geometry.parameters.width/2,halfCube-mo.geometry.parameters.width/2);
            mo.position.y=clamp(mo.position.y,-halfCube+mo.geometry.parameters.height/2,halfCube-mo.geometry.parameters.height/2);
          }
          tg.add(mo);
        });
        if(!checkCollisionsInGroup(tg)) found=cm;
      });
      if(found){
        attributeMapping=found;
        document.getElementById('attrMapping').value = `${found.forma},${found.color},${found.x},${found.y},${found.z}`;
        updateScene(false);
        updateTopRightDisplay();
      } else {
        showPopup("No se encontró reorganización sin colisiones.",7000);
      }
    }

    // === Tooltip
    function showPopup(msg,dur=2000){
      let p=document.getElementById('hoverPopup');
      p.style.display="block"; p.style.opacity=1;
      p.style.left=(window.innerWidth/2-150)+"px";
      p.style.top="20px";
      p.innerHTML=msg;
      setTimeout(()=>{
        p.style.opacity=0;
        setTimeout(()=>{ p.style.display="none"; p.innerHTML=""; },300);
      },dur);
    }

    // === Actualizar escena
    function updateScene(attemptResolve=true){
      while(permutationGroup.children.length>0){
        let o=permutationGroup.children[0];
        permutationGroup.remove(o);
        o.geometry.dispose(); o.material.dispose();
      }
      let opts=Array.from(document.getElementById('permutationList').selectedOptions);
      opts.forEach((o,i)=>{
        let pa=o.value.split(',').map(Number),
            obj=createPermutationObject(pa,i);
        if(opts.length>1){
          let ang=2*Math.PI*i/opts.length, rad=1.5;
          obj.position.x+=rad*Math.cos(ang);
          obj.position.y+=rad*Math.sin(ang);
          obj.position.x=clamp(obj.position.x,-halfCube+obj.geometry.parameters.width/2,halfCube-obj.geometry.parameters.width/2);
          obj.position.y=clamp(obj.position.y,-halfCube+obj.geometry.parameters.height/2,halfCube-obj.geometry.parameters.height/2);
        }
        permutationGroup.add(obj);
      });
      if(attemptResolve) autoResolveColisionesGlobal();
      else updateTopRightDisplay();
    }

    // === Raycast hover
    function onMouseMove(e){
      mouse.x=(e.clientX/window.innerWidth)*2-1;
      mouse.y=-(e.clientY/window.innerHeight)*2+1;
      raycaster.setFromCamera(mouse,camera);
      let ints=raycaster.intersectObjects(permutationGroup.children);
      let pop=document.getElementById('hoverPopup');
      if(ints.length>0){
        let d=ints[0].object.userData;
        pop.style.display="block"; pop.style.opacity=1;
        pop.style.left=e.clientX+20+"px"; pop.style.top=e.clientY+20+"px";
        pop.innerHTML=`Perm (${d.permStr})<br>Firma [${d.signature.join(', ')}]<br>Rango ${d.range}`;
      } else {
        pop.style.opacity=0;
        setTimeout(()=>{ pop.style.display="none"; },300);
      }
    }

    // === Zoom & movimiento
    function zoomIn(){ camera.position.z-=5; controls.update(); }
    function zoomOut(){ camera.position.z+=5; controls.update(); }
    function togglePause(){
      isPaused=!isPaused;
      let b=document.querySelector("button[onclick='togglePause()']");
      b.textContent=isPaused?"Reanudar Movimiento":"Pausar Movimiento";
    }
    function resetMovement(){
      updateScene(false);
      isPaused=true;
      let b=document.querySelector("button[onclick='togglePause()']");
      b.textContent="Reanudar Movimiento";
    }

    // === Guardar imagen
    function saveImage(){
      renderer.render(scene,camera);
      let url=renderer.domElement.toDataURL("image/png"),
          a=document.createElement("a");
      a.href=url; a.download="configuracion_frontal.png";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // === Colores manuales
    function updateColorMapping(){
      for(let i=1;i<=5;i++){
        colorMapping[i]=document.getElementById('color'+i).value;
      }
      updateScene(false);
    }
    function updateBackground(){
      let c=document.getElementById('bgColor').value;
      scene.background=new THREE.Color(c);
      let lum=(parseInt(c.slice(1,3),16)*299+parseInt(c.slice(3,5),16)*587+parseInt(c.slice(5,7),16)*114)/1000;
      document.getElementById('hoverPopup').style.color=lum<128?"#fff":"#000";
    }
    function updateCubeColor(){
      let c=document.getElementById('cubeColor').value;
      cubeUniverse.material.color=new THREE.Color(c);
      document.querySelectorAll("details summary").forEach(s=>s.style.color=c);
      document.getElementById('toggleTextButton').style.color=c;
    }

    // === Toggle texts
    function toggleTexts(){
      let elems=['controls','topRightDisplay','ratingContainer','randomConfigButton','saveImageButton','exportEmbedButton']
        .map(id=>document.getElementById(id));
      elems.forEach(e=> e.style.display = textsVisible ? "none" : "block" );
      document.getElementById('toggleTextButton').textContent =
        textsVisible ? "Mostrar Textos" : "Ocultar Textos";
      textsVisible=!textsVisible;
    }

    // === Modo manual/evolutivo
    function setMode(m){
      currentMode=m;
      document.getElementById('manualControls').style.display=(m==="manual"?"block":"none");
      document.getElementById('evolutionControls').style.display=(m==="evolution"?"block":"none");
      updateScene(false);
    }

    // === Configuración aleatoria
    function generateRandomConfiguration(){
      let sel=document.getElementById('permutationList');
      Array.from(sel.options).forEach(o=>o.selected=false);
      let n=Math.floor(Math.random()*5)+1;
      for(let i=0;i<n;i++){
        let val=permutationStrings[Math.floor(Math.random()*permutationStrings.length)];
        sel.querySelector(`option[value="${val}"]`).selected=true;
      }
      let bg=CUSTOM_COLORS[Math.floor(Math.random()*CUSTOM_COLORS.length)],
          wall=CUSTOM_COLORS[Math.floor(Math.random()*CUSTOM_COLORS.length)];
      document.getElementById('bgColor').value=bg; updateBackground();
      document.getElementById('cubeColor').value=wall; updateCubeColor();
      let pool=shuffle(CUSTOM_COLORS.slice());
      for(let i=1;i<=5;i++){
        let hex=pool.shift();
        colorMapping[i]=hex;
        document.getElementById('color'+i).value=hex;
      }
      updateScene(false);
    }

    // === Calificaciones
    document.querySelectorAll('.ratingBtn').forEach(el=>{
      let r=+el.getAttribute('data-rating');
      el.addEventListener('click',()=>{
        userRating=r;
        let cols={1:"#8B0000",2:"#FF4500",3:"#FFA500",4:"#9ACD32",5:"#008000"};
        document.querySelectorAll('.ratingBtn').forEach((b,i)=>{
          b.style.color=(i<r?cols[r]:"#000");
        });
        db.collection("ratings").add({
          rating: r,
          config: {
            perms: Array.from(document.getElementById('permutationList').selectedOptions).map(o=>o.value),
            mapping: attributeMapping,
            colors: [1,2,3,4,5].map(i=> colorMapping[i] ),
            bg: document.getElementById('bgColor').value,
            cube: document.getElementById('cubeColor').value
          },
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        updateTopRightDisplay();
      });
      el.addEventListener('mouseenter',()=> showPopup(`Calificación: ${r}`,1000));
    });

    // === Evolución
    function applyEvolution(){
      let mr=parseFloat(document.getElementById('mutationRate').value),
          th=parseFloat(document.getElementById('threshold').value),
          cf=0.02, log="";
      let top=window.topConfigs||[];
      permutationGroup.children.forEach(o=>{
        let rf=(Math.random()-0.5)*mr;
        o.rotation.y+=rf;
        log+=`(${o.userData.permStr}): Rot ${rf.toFixed(3)}<br>`;
      });
      document.getElementById('evolutionInfo').innerHTML=log;
    }

    // === Aplicar mapping
    function updateMapping(){
      let v=document.getElementById('attrMapping').value.split(',').map(Number);
      if(v.length===5){
        attributeMapping={forma:v[0],color:v[1],x:v[2],y:v[3],z:v[4]};
        updateScene(false); updateTopRightDisplay();
      }
    }

    // === Vista estándar
    function applyStandardView(){
      let view=document.getElementById('standardView').value,
          pos=new THREE.Vector3();
      switch(view){
        case "isometric": pos.set(50,50,50); break;
        case "top": pos.set(0,80,0); break;
        case "front": pos.set(0,0,50); break;
        case "side": pos.set(50,0,0); break;
        case "diagonal": pos.set(-50,50,-50); break;
        default: pos.set(0,0,50);
      }
      camera.position.copy(pos);
      camera.lookAt(new THREE.Vector3(0,0,0));
      controls.update();
    }

    // === Export embed
    function exportEmbed(){
      const perms=Array.from(document.getElementById('permutationList').selectedOptions).map(o=>o.value).join(';');
      const mapping=[attributeMapping.forma,attributeMapping.color,attributeMapping.x,attributeMapping.y,attributeMapping.z].join(',');
      const colors=[1,2,3,4,5].map(i=> document.getElementById('color'+i).value.substring(1) ).join(',');
      const bg=document.getElementById('bgColor').value.substring(1);
      const cube=document.getElementById('cubeColor').value.substring(1);
      const view=document.getElementById('standardView').value;
      const src=`${location.pathname}?perms=${encodeURIComponent(perms)}&mapping=${mapping}&colors=${encodeURIComponent(colors)}&bg=${bg}&cube=${cube}&view=${view}&hide=1`;
      const embed=`<iframe src="${src}" width="800" height="600" frameborder="0"></iframe>`;
      prompt("Copia este código para embeber:", embed);
    }

    // === Inicialización
    function initCustomCursor(){
      let c=document.getElementById('customCursor');
      window.addEventListener('mousemove',e=>{ c.style.left=e.clientX+"px"; c.style.top=e.clientY+"px"; });
    }
    function initRenderer(){
      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth,window.innerHeight);
      document.body.appendChild(renderer.domElement);
    }
    function init(){
      scene=new THREE.Scene();
      scene.background=new THREE.Color(0xffffff);
      camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
      camera.position.set(0,0,50);
      initRenderer();
      controls=new THREE.OrbitControls(camera,renderer.domElement);
      controls.enableDamping=true; controls.dampingFactor=0.1; controls.enableZoom=true;
      scene.add(new THREE.AmbientLight(0xffffff,0.8));
      let dir=new THREE.DirectionalLight(0xffffff,0.5); dir.position.set(1,1,1); scene.add(dir);
      let cubeGeo=new THREE.BoxGeometry(cubeSize,cubeSize,cubeSize),
          cubeMat=new THREE.MeshBasicMaterial({ color:0x808080,transparent:true,opacity:0.2,side:THREE.BackSide });
      cubeUniverse=new THREE.Mesh(cubeGeo,cubeMat); scene.add(cubeUniverse);
      permutationGroup=new THREE.Group(); scene.add(permutationGroup);
      raycaster=new THREE.Raycaster(); mouse=new THREE.Vector2();
      window.addEventListener('mousemove',onMouseMove,false);
      window.addEventListener('resize',onWindowResize,false);

      initCustomCursor();
      populatePermutationList();
      populateAttributeMappingSelect();
      setMode("manual");
      updateScene(false);
      animate();
    }
    function onWindowResize(){
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    }
    function animate(){
      requestAnimationFrame(animate);
      if(!isPaused){
        permutationGroup.children.forEach(o=>{ if(o.userData.rotationSpeed) o.rotation.y+=o.userData.rotationSpeed; });
      }
      controls.update();
      renderer.render(scene,camera);
    }
    init();
  </script>
</body>
</html>
