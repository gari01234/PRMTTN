<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualizador 3D de Permutaciones – Modular y Evolución AI</title>
  <style>
    /* ———————————————————————— Global & Body ———————————————————————— */
    body {
      margin: 0;
      overflow: hidden;
      background: #ffffff;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-weight: 200;
      font-size: 12px;
      cursor: none;
    }
    #customCursor {
      position: fixed;
      width: 12px; height: 12px;
      border-radius: 50%;
      background: #000;
      border: 1px solid #fff;
      pointer-events: none;
      z-index: 300;
      transform: translate(-50%, -50%);
    }
    #topRightDisplay {
      position: fixed; top: 5px; right: 10px; z-index: 280;
      color: #000; font-size: 12px; line-height: 1.2;
    }

    /* ———————————————————————— Botones flotantes ———————————————————————— */
    button {
      cursor: none;
      border: none; border-radius: 4px;
      padding: 8px 12px; font-size: 12px; z-index: 250;
      background: rgba(255,255,255,0.8);
    }
    #toggleTextButton    { bottom: 10px;  right: 10px; position: fixed; }
    #randomConfigButton  { bottom: 40px;  right: 10px; position: fixed; }
    #evolutionAIButton   { bottom: 70px;  right: 10px; position: fixed; }
    #export3DButton      { bottom:100px;  right: 10px; position: fixed; }
    #toggleModularButton { bottom:130px;  right: 10px; position: fixed; }

    /* ———————————————————————— Controles laterales ———————————————————————— */
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 100;
      padding: 10px; border-radius: 5px;
      background: rgba(255,255,255,0.9); max-width: 360px;
    }
    details { margin-bottom: 10px; }
    details summary { font-weight: 200; cursor: pointer; }
    details summary:hover { color: #333; }
    select, input[type="range"], input[type="color"], input[type="number"] {
      cursor: none; width: 100%; margin-top:4px;
    }
    #permutationList { width: 100%; height: 100px; }

    /* ———————————————————————— Rating ———————————————————————— */
    #ratingContainer {
      position: fixed; bottom: 170px; right: 10px; z-index: 260;
      font-size: 12px;
    }
    #ratingLabels, #ratingDots {
      display: flex; justify-content: space-between;
    }
    .ratingBtn {
      font-size: 20px; cursor: none; color: #000;
    }

    /* ———————————————————————— Tooltip Hover ———————————————————————— */
    #hoverPopup {
      position: absolute; padding: 5px 10px;
      background: rgba(0,0,0,0.7); color: #fff;
      border-radius: 4px; pointer-events: none;
      font-size: 12px; display: none; opacity: 0;
      transition: opacity .3s; z-index: 200;
    }

    /* ———————————————————————— Canvas ———————————————————————— */
    canvas { display: block; }

  </style>
</head>
<body>
  <div id="customCursor"></div>
  <div id="topRightDisplay"></div>

  <!-- Botones flotantes -->
  <button id="toggleTextButton"    onclick="toggleTexts()">Ocultar Textos</button>
  <button id="randomConfigButton"  onclick="generateRandomConfiguration()">Config. Aleatoria</button>
  <button id="evolutionAIButton"   onclick="applyEvolutionAI()">Evolución AI</button>
  <button id="export3DButton"      onclick="exportGLB()">Mint NFT 3D</button>
  <button id="toggleModularButton" onclick="toggleModular()">Modo Modular</button>

  <!-- Rating -->
  <div id="ratingContainer">
    <details open>
      <summary>Calificar Configuración</summary>
      <div id="ratingControls">
        <div id="ratingLabels">
          <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
        </div>
        <div id="ratingDots">
          <span class="ratingBtn" data-rating="1">●</span>
          <span class="ratingBtn" data-rating="2">●</span>
          <span class="ratingBtn" data-rating="3">●</span>
          <span class="ratingBtn" data-rating="4">●</span>
          <span class="ratingBtn" data-rating="5">●</span>
        </div>
      </div>
    </details>
  </div>

  <!-- Panel de controles -->
  <div id="controls">
    <!-- Modo de Operación -->
    <details open>
      <summary>Modo de Operación</summary>
      <label><input type="radio" name="mode" value="manual" checked onchange="setMode(this.value)"> Manual</label><br>
      <label><input type="radio" name="mode" value="evolution" onchange="setMode(this.value)"> Evolutivo</label><br>
      <label><input type="radio" name="mode" value="modular" onchange="setMode(this.value)"> Modular</label>
    </details>

    <!-- Controles Manual -->
    <div id="manualControls">
      <details>
        <summary>Seleccionar Permutaciones</summary>
        <select id="permutationList" multiple></select>
        <button onclick="updateActiveUniverse()">Asignar Universo</button>
      </details>
    </div>

    <!-- Controles Evolutivo -->
    <div id="evolutionControls" style="display:none;">
      <details>
        <summary>Parámetros Evolutivos</summary>
        <p>Tasa de Mutación: <input type="range" id="mutationRate" min="0" max="1" step="0.01" value="0.1"></p>
        <p>Umbral de Cambio: <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.5"></p>
      </details>
    </div>

    <!-- Controles Modular -->
    <div id="modularControls" style="display:none;">
      <details>
        <summary>Selector Universo Activo</summary>
        <select id="universeSelect"></select>
      </details>
      <details>
        <summary>Fondo: Global vs Individual</summary>
        <label><input type="radio" name="bgMode" value="global" checked onchange="updateBGMode(this.value)"> Global</label><br>
        <label><input type="radio" name="bgMode" value="individual" onchange="updateBGMode(this.value)"> Individual</label>
        <div id="bgPickersGlobal" style="margin-top:8px;">
          <input type="color" id="bgColorGlobal" value="#ffffff" onchange="applyBackground()"> Fondo Global
        </div>
        <div id="bgPickersIndividual" style="display:none; margin-top:8px;">
          <!-- Se llenará dinámicamente con 9 pickers -->
          <div id="bgColorsIndividual"></div>
        </div>
      </details>
    </div>

  </div>

  <div id="hoverPopup"></div>

  <!-- Three.js, OrbitControls, GLTFExporter, Ethers.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://threejs.org/examples/js/exporters/GLTFExporter.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script>
    // ——————————————————————————————————————————————
    // === PALETA DE 120 COLORES ===
    const CUSTOM_COLORS = [
      "#070709","#898052","#402523","#0d080a","#070909","#050608","#070509",
      "#12080d","#330a0d","#9c714f","#382e24","#883933","#decda0",
      "#fafcff","#a4b6bc","#e7e8e1","#f3f1ea","#eaebe2","#dcdacf","#f8f9f8",
      "#f6f5ea","#ffffff","#f3f3f0","#faf9f0","#f5f7f6","#eeece8","#fffef7",
      "#350b0c","#9e4031","#820707","#eeb049","#120607","#f6f1ed",
      "#300809","#8c2d18","#6a6620","#b99c5c","#110505","#5f2423",
      "#400909","#a04b37","#180506","#e1b055","#6f2919","#170607",
      "#000000","#9c822b","#3e1b2c","#edce83","#1b0408","#8a4667",
      "#000000","#ec9b1c","#701a25","#9c2c1a","#480b0b","#150407",
      "#2a0607","#b08b4f","#7a181d","#5d180f","#1f0908","#dfb46e",
      "#0b0304","#a4735a","#4e272a","#cab296","#923930","#1d0709",
      "#f4c061","#963326","#d89048","#430f0c","#ce5830","#72121a",
      "#fefffe","#c0b280","#57231d","#99541e","#210d0a","#8a5d2f",
      "#33090a","#e2a33f","#a24a2c","#591e14","#8f2e1c","#1e0809",
      "#bd4d1d","#441b1d","#0f0406","#e3a337","#886c39","#1a0807",
      "#fffcee","#cea564","#9a7859","#080103","#000003","#000100",
      "#000000","#6d4d2c","#2d060a","#000005","#000100","#2d0006",
      "#17120a","#451e18","#42401c","#7c4934","#8c7640","#c0b468"
    ];

    // ——————————————————————————————————————————————
    // === Variables globales ===
    let scene, camera, renderer, controls, raycaster, mouse;
    const cubeSize = 30, segment = cubeSize/5, halfCube = cubeSize/2;
    let universes = [];      // Array de 9 universos (THREE.Group)
    let activeIndex = 0;     // ÍNDICE de universo activo (0–8)
    let isPaused = false,
        currentMode = "manual",
        userRating = null,
        textsVisible = true,
        bgMode = "global";   // "global" or "individual"
    let colorMapping = {1:"#ff0000",2:"#00ff00",3:"#0000ff",4:"#ff00ff",5:"#00ffff"};
    let universeBG = new Array(9).fill("#ffffff");
    let autoEvoInterval = null, userInteracting = false;

    // Mapeos
    let attributeMapping = { forma:0, color:1, x:2, y:3, z:4 };
    const shapeMapping = {
      1:{w:4.5,h:4.5},
      2:{w:4.5,h:4.5*Math.sqrt(2)},
      3:{w:4.5,h:4.5*Math.sqrt(3)},
      4:{w:4.5,h:4.5*Math.sqrt(4)},
      5:{w:4.5,h:4.5*Math.sqrt(5)}
    };
    const minRangeValue = 2, maxRangeValue = 6;

    // ——————————————————————————————————————————————
    // === Utilidades genéricas ===
    function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
    function mapRangeToSpeed(r,mn,mx){ return 0.001 + (r-mn)*(0.005-0.001)/(mx-mn); }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

    // Generar permutaciones y strings
    function getPermutations(arr){
      if(arr.length===1) return [arr];
      let res=[];
      for(let i=0;i<arr.length;i++){
        let c=arr[i], rem=arr.slice(0,i).concat(arr.slice(i+1));
        for(let p of getPermutations(rem)) res.push([c].concat(p));
      }
      return res;
    }
    const allPermutations = getPermutations([1,2,3,4,5]);
    const permutationStrings = allPermutations.map(p=>p.join(','));

    // Firma y rango
    function computeSignature(a){
      let s=[];
      for(let i=0;i<a.length;i++) s.push(a[i]+a[(i+1)%a.length]);
      return s;
    }
    function computeRange(sig){
      return Math.max(...sig) - Math.min(...sig);
    }

    // ——————————————————————————————————————————————
    // === Poblado de selects & pickers ===
    function populatePermutationList(){
      const sel = document.getElementById('permutationList');
      sel.innerHTML = '';
      permutationStrings.forEach((ps,i)=>{
        const o=document.createElement('option');
        o.value=ps; o.text=`Perm ${i+1}: (${ps})`;
        sel.appendChild(o);
      });
    }
    function populateUniverseSelect(){
      const sel=document.getElementById('universeSelect');
      sel.innerHTML='';
      for(let i=0;i<9;i++){
        const o=document.createElement('option');
        o.value=i; o.text=`Universo ${i+1}`;
        sel.appendChild(o);
      }
    }
    function populateBGIndividual(){
      const container=document.getElementById('bgColorsIndividual');
      container.innerHTML='';
      for(let i=0;i<9;i++){
        const div=document.createElement('div');
        div.style.margin='4px 0';
        const inp=document.createElement('input');
        inp.type='color'; inp.value=universeBG[i];
        inp.onchange=()=>{ universeBG[i]=inp.value; applyBackground(); };
        div.appendChild(document.createTextNode(`Cub ${i+1}: `));
        div.appendChild(inp);
        container.appendChild(div);
      }
    }

    // ——————————————————————————————————————————————
    // === Display superior y popups ===
    function updateTopRightDisplay(){
      const cfg=`Modo: ${currentMode.toUpperCase()} | Activo: ${activeIndex+1}`;
      const rt=`Rating: ${userRating||'–'}`;
      document.getElementById('topRightDisplay').innerHTML = cfg + ' | ' + rt;
    }
    function showPopup(msg, dur=2000){
      const p=document.getElementById('hoverPopup');
      p.style.display='block'; p.style.opacity=1;
      p.style.left=(window.innerWidth/2-150)+'px';
      p.style.top='20px';
      p.innerHTML=msg;
      setTimeout(()=>{
        p.style.opacity=0;
        setTimeout(()=>{ p.style.display='none'; },300);
      }, dur);
    }

    // ——————————————————————————————————————————————
    // === Manejo de Modo y UI visibilidad ===
    function setMode(m){
      currentMode = m;
      document.getElementById('manualControls').style.display    = (m==='manual'   ? 'block':'none');
      document.getElementById('evolutionControls').style.display = (m==='evolution'? 'block':'none');
      document.getElementById('modularControls').style.display   = (m==='modular'  ? 'block':'none');
      updateTopRightDisplay();
      resetScene();
      initScene();
    }
    function toggleTexts(){
      textsVisible = !textsVisible;
      ['controls','toggleTextButton','randomConfigButton','evolutionAIButton','export3DButton','toggleModularButton','ratingContainer']
      .forEach(id=>{
        document.getElementById(id).style.display = textsVisible ? 'block':'none';
      });
    }
    function toggleModular(){
      const btn=document.getElementById('toggleModularButton');
      setMode(currentMode==='modular'?'manual':'modular');
      btn.textContent = currentMode==='modular' ? 'Modo Estándar' : 'Modo Modular';
    }
    function updateBGMode(val){
      bgMode=val;
      document.getElementById('bgPickersGlobal').style.display     = (val==='global'?'block':'none');
      document.getElementById('bgPickersIndividual').style.display = (val==='individual'?'block':'none');
    }
    // ——————————————————————————————————————————————
    // === Creación y reinicio de escena ===
    function resetScene(){
      // Limpia viejo renderer y objetos
      if(renderer && scene){
        while(scene.children.length) scene.remove(scene.children[0]);
        renderer.domElement.remove();
      }
    }
    function initScene(){
      // Renderer
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
      camera.position.set(0,0,100);
      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setSize(innerWidth, innerHeight);
      document.body.appendChild(renderer.domElement);

      // Controles
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.addEventListener('start',()=>userInteracting=true);
      controls.addEventListener('end', ()=>userInteracting=false);

      // Luz
      scene.add(new THREE.AmbientLight(0xffffff, 0.8));
      const dir = new THREE.DirectionalLight(0xffffff,0.5);
      dir.position.set(1,1,1);
      scene.add(dir);

      // Raycaster
      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();
      window.addEventListener('mousemove', onMouseMove);

      // Crea universos
      universes = [];
      const gridSize = 3, spacing = cubeSize * 1.5;
      for(let i=0;i<gridSize;i++){
        for(let j=0;j<gridSize;j++){
          const idx = i*gridSize + j;
          const group = new THREE.Group();
          group.position.set((j-1)*spacing, (1-i)*spacing, 0);
          scene.add(group);
          universes.push({ group, bgPlane:null });
        }
      }

      // Añade cubos y fondos
      universes.forEach((u, idx)=>{
        // Fondo individual
        const plane = new THREE.Mesh(
          new THREE.PlaneGeometry(cubeSize,cubeSize),
          new THREE.MeshBasicMaterial({ color:universeBG[idx], side:THREE.DoubleSide })
        );
        plane.position.copy(u.group.position);
        plane.position.z -= cubeSize/2 + 0.1;
        scene.add(plane);
        u.bgPlane = plane;

        // Cubo
        const geo = new THREE.BoxGeometry(cubeSize,cubeSize,cubeSize);
        const mat = new THREE.MeshBasicMaterial({ color:0x808080, transparent:true, opacity:0.2, side:THREE.BackSide });
        const m = new THREE.Mesh(geo, mat);
        u.group.add(m);
      });

      // UI
      populatePermutationList();
      populateUniverseSelect();
      populateBGIndividual();

      // Primer render loop
      animate();
    }

    // ——————————————————————————————————————————————
    // === Raycast para hover info ===
    function onMouseMove(e){
      mouse.x = (e.clientX/innerWidth)*2-1;
      mouse.y = -(e.clientY/innerHeight)*2+1;
      raycaster.setFromCamera(mouse, camera);
      // Sólo universo activo
      const objs = universes[activeIndex].group.children.slice(1); // saltar caja
      const ints = raycaster.intersectObjects(objs);
      const pop = document.getElementById('hoverPopup');
      if(ints.length){
        const d = ints[0].object.userData;
        pop.style.display='block'; pop.style.opacity=1;
        pop.style.left=`${e.clientX+20}px`;
        pop.style.top=`${e.clientY+20}px`;
        pop.innerHTML = `Perm(${d.permStr})<br>Rango ${d.range}`;
      } else {
        pop.style.opacity=0;
        setTimeout(()=>pop.style.display='none',300);
      }
    }

    // ——————————————————————————————————————————————
    // === Crear y actualizar permutaciones ===
    function createPermutationObject(pa){
      const fv=pa[attributeMapping.forma],
            cv=pa[attributeMapping.color],
            d=shapeMapping[fv],
            mesh = new THREE.Mesh(
              new THREE.BoxGeometry(d.w,d.h,0.5),
              new THREE.MeshPhongMaterial({ color:new THREE.Color(colorMapping[cv]), shininess:50 })
            );
      // Posición en su cubo
      const seg = segment;
      const x=(pa[attributeMapping.x]-1)*seg-halfCube+seg/2;
      const y=(pa[attributeMapping.y]-1)*seg-halfCube+seg/2;
      mesh.position.set(x,y,0);
      const sig = computeSignature(pa), rg = computeRange(sig);
      mesh.userData = { permStr:pa.join(','), range: rg, rotationSpeed: mapRangeToSpeed(rg,minRangeValue,maxRangeValue) };
      return mesh;
    }
    function updateActiveUniverse(){
      activeIndex = parseInt(document.getElementById('universeSelect').value);
      updateTopRightDisplay();
    }
    function updateScene(){
      const u = universes[activeIndex];
      // Limpia permutaciones previas (hijos desde índice 2 en adelante)
      while(u.group.children.length>2) {
        const o = u.group.children.pop();
        o.geometry.dispose(); o.material.dispose();
      }
      // Añade nuevas
      const opts = Array.from(document.getElementById('permutationList').selectedOptions);
      opts.forEach((o,i)=>{
        const pa = o.value.split(',').map(Number),
              obj= createPermutationObject(pa);
        u.group.add(obj);
      });
    }

    // ——————————————————————————————————————————————
    // === Comunicación Ligera: broadcast de ratings ===
    function broadcastRatings(){
      const u = universes[activeIndex];
      const objs = u.group.children.slice(2);
      objs.forEach(o=>{
        o.userData.avgRating = userRating || 3;
      });
      // Ajuste simple: cada cubo ajusta su escala si está por debajo/encima del promedio local
      const avgLocal = objs.reduce((s,o)=>s+o.userData.avgRating,0)/objs.length;
      objs.forEach(o=>{
        if(o.userData.avgRating < avgLocal) o.scale.multiplyScalar(1.02);
        else if(o.userData.avgRating > avgLocal) o.scale.multiplyScalar(0.98);
      });
    }

    // ——————————————————————————————————————————————
    // === Evolución simple y AI ===
    function applyEvolutionSimple(){
      const u = universes[activeIndex];
      u.group.children.slice(2).forEach(o=>{
        const rf=(Math.random()-0.5)*parseFloat(document.getElementById('mutationRate').value);
        o.rotation.y += rf;
      });
    }
    async function applyEvolutionAI(){
      showPopup("Evolución AI…",2000);
      // Igual que antes: petición fetch al Functions Framework…
      // parseo JSON e iteración sobre universes[activeIndex].group.children.slice(2)
      // (por brevedad, omitido, réplica de tu lógica actual)
    }

    // ——————————————————————————————————————————————
    // === Scheduler de Evolución automática ===
    function startAutoEvolution(intervalSec=30){
      if(autoEvoInterval) clearInterval(autoEvoInterval);
      autoEvoInterval = setInterval(()=>{
        if(!userInteracting){
          applyEvolutionAI();
          broadcastRatings();
        }
      }, intervalSec*1000);
    }
    function stopAutoEvolution(){
      if(autoEvoInterval) clearInterval(autoEvoInterval);
    }

    // ——————————————————————————————————————————————
    // === Export 3D & Mint NFT ===
    function exportGLB(){
      const exporter = new THREE.GLTFExporter();
      const u = universes[activeIndex];
      exporter.parse(u.group, gltf => {
        const blob = new Blob([gltf], { type:'model/gltf-binary' });
        uploadToIPFS(blob).then(hash=>mintNFT(hash));
      }, { binary:true });
    }
    async function uploadToIPFS(blob){
      const form = new FormData();
      form.append('file', blob, 'scene.glb');
      const resp = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
        method:'POST',
        headers:{ Authorization:'Bearer PINATA_JWT' },
        body: form
      });
      const { IpfsHash } = await resp.json();
      return IpfsHash;
    }
    async function mintNFT(ipfsHash){
      await ethereum.request({ method:'eth_requestAccounts' });
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer   = provider.getSigner();
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const uri = `ipfs://${ipfsHash}`;
      const tx = await contract.mintToken(await signer.getAddress(), uri);
      await tx.wait();
      alert('Mint completado: '+uri);
    }

    // ——————————————————————————————————————————————
    // === Inicialización & loop ===
    function animate(){
      requestAnimationFrame(animate);
      universes.forEach(u=>{
        u.group.children.slice(2).forEach(o=>{
          if(o.userData.rotationSpeed) o.rotation.y += o.userData.rotationSpeed;
        });
      });
      controls.update();
      renderer.render(scene,camera);
    }
    window.addEventListener('resize', ()=> {
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth,innerHeight);
    });

    // — Arranca todo —
    initScene();
    startAutoEvolution(30);

    // — Rating UI —
    document.querySelectorAll('.ratingBtn').forEach(el=>{
      const r = +el.dataset.rating;
      el.addEventListener('click', ()=>{
        userRating = r;
        document.querySelectorAll('.ratingBtn').forEach((b,i)=>b.style.color = (i<r? '#f00':'#000'));
        updateTopRightDisplay();
      });
    });

    // — Toggle texto personalizado —
    document.getElementById('toggleTextButton').onclick = toggleTexts;

  </script>
</body>
</html>
